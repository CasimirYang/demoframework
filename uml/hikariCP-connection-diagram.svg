<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="522px" preserveAspectRatio="none" style="width:1795px;height:522px;" version="1.1" viewBox="0 0 1795 522" width="1795px" zoomAndPan="magnify"><defs><filter height="300%" id="f14l906tqgczgy" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="228" x2="228" y1="41.1201" y2="479.6816"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="505" x2="505" y1="41.1201" y2="479.6816"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="818" x2="818" y1="41.1201" y2="479.6816"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1115" x2="1115" y1="41.1201" y2="479.6816"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1338" x2="1338" y1="41.1201" y2="479.6816"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1520.5" x2="1520.5" y1="41.1201" y2="479.6816"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1710" x2="1710" y1="41.1201" y2="479.6816"/><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="124" x="164" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="110" x="171" y="26.0439">HikariDataSource</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="124" x="164" y="478.6816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="110" x="171" y="501.7256">HikariDataSource</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="108" x="449" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="94" x="456" y="26.0439">pool.HikariPool</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="108" x="449" y="478.6816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="94" x="456" y="501.7256">pool.HikariPool</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="170" x="731" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="156" x="738" y="26.0439">hikari.util.ConcurrentBag</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="170" x="731" y="478.6816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="156" x="738" y="501.7256">hikari.util.ConcurrentBag</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="1060" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1067" y="26.0439">pool.PoolEntry</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="1060" y="478.6816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1067" y="501.7256">pool.PoolEntry</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1272" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1279" y="26.0439">pool.ProxyFactory</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1272" y="478.6816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1279" y="501.7256">pool.ProxyFactory</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="1425.5" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="1432.5" y="26.0439">pool.HikariProxyConnection</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="1425.5" y="478.6816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="1432.5" y="501.7256">pool.HikariProxyConnection</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="1632" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="1639" y="26.0439">pool.ProxyConnection</text><rect fill="#FEFECE" filter="url(#f14l906tqgczgy)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="1632" y="478.6816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="1639" y="501.7256">pool.ProxyConnection</text><path d="M8,56.1201 L8,83.1201 L219,83.1201 L219,66.1201 L209,56.1201 L8,56.1201 " fill="#FBFB77" filter="url(#f14l906tqgczgy)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M209,56.1201 L209,66.1201 L219,66.1201 L209,56.1201 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="14" y="76.0181">hikariDataSource.getConnection(</text><polygon fill="#A80036" points="493,165.8921,503,169.8921,493,173.8921,497,169.8921" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="228" x2="499" y1="169.8921" y2="169.8921"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="235" y="111.7725">获取顺序：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="239" y="129.5269">1.fastPathPool.getConnection()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="239" y="147.2813">2.pool.getConnection()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="239" y="165.0356">3.new HikariPool(this);pool.getConnection()</text><polygon fill="#A80036" points="806,197.6465,816,201.6465,806,205.6465,810,201.6465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="505" x2="812" y1="201.6465" y2="201.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="512" y="196.79">borrow poolEntry from ConcurrentBag&lt;PoolEntry&gt;</text><polygon fill="#A80036" points="516,229.4009,506,233.4009,516,237.4009,512,233.4009" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="510" x2="817" y1="233.4009" y2="233.4009"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="522" y="228.5444">poolEntry</text><polygon fill="#A80036" points="1103,278.9097,1113,282.9097,1103,286.9097,1107,282.9097" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="505" x2="1109" y1="282.9097" y2="282.9097"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="486" x="512" y="260.2988">如果isMarkedEvicted || !isConnectionAlive(poolEntry.connection) -&gt; closeConnection</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="582" x="516" y="278.0532">否则通过 poolEntry.createProxyConnection(leakTaskFactory.schedule(poolEntry), now)创建连接代理</text><path d="M1203,295.9097 L1203,322.9097 L1329,322.9097 L1329,305.9097 L1319,295.9097 L1203,295.9097 " fill="#FBFB77" filter="url(#f14l906tqgczgy)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1319,295.9097 L1319,305.9097 L1329,305.9097 L1319,295.9097 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1209" y="315.8076">通过Javassist修改</text><polygon fill="#A80036" points="1326,352.4185,1336,356.4185,1326,360.4185,1330,356.4185" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1115" x2="1332" y1="356.4185" y2="356.4185"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="1122" y="351.562">ProxyFactory.getProxyConnection</text><path d="M1386,369.4185 L1386,396.4185 L1512,396.4185 L1512,379.4185 L1502,369.4185 L1386,369.4185 " fill="#FBFB77" filter="url(#f14l906tqgczgy)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1502,369.4185 L1502,379.4185 L1512,379.4185 L1502,369.4185 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1392" y="389.3164">通过Javassist生成</text><polygon fill="#A80036" points="1509,425.9272,1519,429.9272,1509,433.9272,1513,429.9272" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1338" x2="1515" y1="429.9272" y2="429.9272"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1345" y="425.0708">new HikariProxyConnection</text><polygon fill="#A80036" points="1698,457.6816,1708,461.6816,1698,465.6816,1702,461.6816" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1521" x2="1704" y1="461.6816" y2="461.6816"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="1528" y="456.8252">invoke by super construction</text><!--
@startuml
note left of HikariDataSource: hikariDataSource.getConnection(
HikariDataSource -> pool.HikariPool: 获取顺序：\n 1.fastPathPool.getConnection() \n 2.pool.getConnection() \n 3.new HikariPool(this);pool.getConnection()
pool.HikariPool-> hikari.util.ConcurrentBag: borrow poolEntry from ConcurrentBag<PoolEntry>
hikari.util.ConcurrentBag - -> pool.HikariPool: poolEntry
pool.HikariPool -> pool.PoolEntry: 如果isMarkedEvicted || !isConnectionAlive(poolEntry.connection) -> closeConnection \n 否则通过 poolEntry.createProxyConnection(leakTaskFactory.schedule(poolEntry), now)创建连接代理
note left of pool.ProxyFactory:通过Javassist修改
pool.PoolEntry -> pool.ProxyFactory: ProxyFactory.getProxyConnection
note left of pool.HikariProxyConnection:通过Javassist生成
pool.ProxyFactory -> pool.HikariProxyConnection: new HikariProxyConnection
pool.HikariProxyConnection -> pool.ProxyConnection: invoke by super construction
@enduml

PlantUML version 1.2018.11(Sun Sep 23 00:43:53 CST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1343-b26
Operating System: Windows 10
OS Version: 10.0
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>